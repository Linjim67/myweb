<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>


<body>

    <div id="tsparticles"></div>

    <div class="dashboard-container">

        <div class="dashboard-header">
            <h1>ğŸ‘‹ æ­¡è¿å›ä¾†ï¼Œ<span id="user-name">åŒå­¸</span></h1>
            <p>å…¥å­¸å¹´åº¦ (Class Year): <span id="user-year" style="font-weight:bold; color:#54a0ff;">...</span></p>
        </div>

        <div class="download-card" onclick="downloadTranscript()">
            <span class="card-tag"
                style="background-color: #0984e3; color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: bold;">PDF
                æ–‡ä»¶</span>

            <div class="download-icon">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
            </div>

            <h3>æˆ‘çš„æˆç¸¾å–®</h3>
            <p style="color: #7f8c8d; margin-top: 10px; font-size: 0.9rem;">é»æ“Šä¸‹è¼‰å€‹äººæª”æ¡ˆ</p>
        </div>

        <button class="logout-btn" onclick="logout()">ç™»å‡º (Logout)</button>
        <br>
        <a href="/"
            style="display: inline-block; margin-top: 20px; color: #b2bec3; text-decoration: none; font-size: 0.9rem;">â†
            å›é¦–é </a>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.0.6/tsparticles.slim.bundle.min.js"></script>
    <script>
        // --- A. Particle Background Setup ---
        (async () => {
            await tsParticles.load("tsparticles", {
                particles: {
                    color: { value: "#888888" },
                    links: { enable: true, color: "#888888", distance: 150, opacity: 0.5 },
                    move: { enable: true, speed: 1 },
                    number: { value: 60, density: { enable: true, area: 800 } },
                    opacity: { value: 0.5 },
                    size: { value: { min: 1, max: 3 } },
                }
            });
        })();

        // --- B. User Authentication Check ---
        // Retrieve the user info saved in LocalStorage during login
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        if (!currentUser) {
            // If user is not logged in, redirect them immediately
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = '/login';
        } else {
            // If logged in, display their Name and Admission Year
            document.getElementById('user-name').innerText = currentUser.username;
            document.getElementById('user-year').innerText = currentUser.admission_year || "(æœªè¨­å®š)";
        }

        // --- C. Download Logic (Auto-Match System) ---
        function downloadTranscript() {
            const username = currentUser.username;
            const admission_year = currentUser.admission_year;

            if (!admission_year) {
                alert("éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿç¼ºå°‘å…¥å­¸å¹´åº¦è³‡æ–™ (Missing Admission Year)");
                return;
            }

            // Create a hidden form to send the data via POST
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/get-transcript'; // This must match your server.js route

            // Input 1: Username
            const inputUser = document.createElement('input');
            inputUser.type = 'hidden';
            inputUser.name = 'username';
            inputUser.value = username;
            form.appendChild(inputUser);

            // Input 2: Admission Year (Tells server which folder to look in)
            const inputYear = document.createElement('input');
            inputYear.type = 'hidden';
            inputYear.name = 'admission_year';
            inputYear.value = admission_year;
            form.appendChild(inputYear);

            // Submit the form to start download
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        // --- D. Logout Logic ---
        function logout() {
            localStorage.removeItem('currentUser'); // Clear data
            window.location.href = '/'; // Go to home page
        }
    </script>
</body>

</html>